# 【转】JavaScript-垃圾回收机制（GC）

就像人类会产生垃圾一样，程序运行过程中也会产生垃圾，如果不及时回收轻则将会拖慢程序运行，重则会导致系统崩溃，也就是所谓的内存泄漏。所以垃圾回收非常必要！

## 一、什么是程序中的垃圾？

简单来说，垃圾就是不需要，已经没用的东西。对应程序中，就是当一个变量没有被其他变量或属性引用的时候，该变量就是程序中的垃圾了。那变量又分局部变量和全局变量，它们的生命周期是不同的，释放内存（垃圾回收）的判断也是不同的。

## 二、变量的生命周期

**全局变量：**
描述：定义在所有函数之外的变量。
生命周期：会持续到浏览器关闭页面

**局部变量：**
描述：定义在某个函数中的变量
生命周期：函数执行过后就结束了，此时便可释放它们占用的内存（垃圾回收）

## 三、数据存储

在Javascript中，基本数据类型存储在栈内存中，[引用数据类型](https://so.csdn.net/so/search?q=引用数据类型&spm=1001.2101.3001.7020)存储在堆内存中，但是引用数据类型会在栈内存中存储一个实际对象的引用。
示例如下：

```javascript
let num = 12;
let obj = {name:'shier', age:'12'};
obj = [1,2,3,4];
```

变量obj和name的存储方式如下图：

<Image :src="'/other/browser/javascript-gc/1.png'" />

如上图中所示粉色块内数据没有被引用变成了垃圾。

## 四、垃圾回收的两种常用方法

了解了以上基础知识后，再来看一下垃圾回收究竟是何物？垃圾回收并不是实时的，因为开销比较大，所以垃圾回收器会周期性的释放程序中已经不在被引用的垃圾对象。那如何判断哪些被引用了，哪些不再被引用？通常会使用以下两种方法来进行判断。

1、标记清除法
这是目前浏览器大多基于标记清除法。我们可以分为两个阶段：

* 标记：从根节点遍历为每个可以访问到的对象都打上一个标记，表示该对象可达。
* 清除：在没有可用分块时，对堆内存遍历，若没有被标记为可达对象就将其回收。

**优点**：实现简单。
**缺点**：a 内存过于碎片化。
     b 内存分配速度慢。
**解决方法**：标记-整理法
标记整理法和标记清除法标记阶段一致，只是整理阶段是先将被引用的对象移动到一端，然后清理掉标记的内存。
视图如下：

<Image :src="'/other/browser/javascript-gc/2.png'" />

2、引用计数法
引用计数法就是追踪每个变量被引用的次数，当引用数为0将可以被回收掉。
**优点**：当引用数为0时会被立即回收。
**缺点**：a 计数器的增减处理频繁，会导致空间的使用效率降低。
     b 循环引用无法收回，导致内存泄漏。
  若有一函数Person中a引用了b，b引用了a。每次调用函数Person，它们的引用计数都不为0，则永远不能被回收。
示例如下：

```javascript
function Person(){
	let a={};
	let b={};
	a.prop = b;
	b.prop = a;
}
```


