import{_ as s,c as n,o as a,h as p}from"./app.9b1cc3ec.js";const m=JSON.parse('{"title":"\u7EC4\u4EF6\u7684\u521B\u5EFA\u548C\u66F4\u65B0\u3010\u4E0B\u3011","description":"","frontmatter":{},"headers":[{"level":2,"title":"\u4E8C\u3001\u7EC4\u4EF6\u7684\u66F4\u65B0updateComponent","slug":"\u4E8C\u3001\u7EC4\u4EF6\u7684\u66F4\u65B0updatecomponent","link":"#\u4E8C\u3001\u7EC4\u4EF6\u7684\u66F4\u65B0updatecomponent","children":[]}],"relativePath":"blogs/front-frame/vue3/sound-code/runtime-core/component-2.md","lastUpdated":1680491167000}'),e={name:"blogs/front-frame/vue3/sound-code/runtime-core/component-2.md"},l=p(`<h1 id="\u7EC4\u4EF6\u7684\u521B\u5EFA\u548C\u66F4\u65B0\u3010\u4E0B\u3011" tabindex="-1">\u7EC4\u4EF6\u7684\u521B\u5EFA\u548C\u66F4\u65B0\u3010\u4E0B\u3011 <a class="header-anchor" href="#\u7EC4\u4EF6\u7684\u521B\u5EFA\u548C\u66F4\u65B0\u3010\u4E0B\u3011" aria-hidden="true">#</a></h1><p>\u4E0A\u4E00\u8282\u6211\u4EEC\u8BB2\u4E86setup\u7EC4\u4EF6\u7684\u521B\u5EFA\uFF0C\u63A5\u4E0B\u6765\u6211\u4EEC\u6765\u8BB2\u8BB2\u66F4\u65B0\u3002</p><p>\u7EC4\u4EF6\u662F\u8D70\u521B\u5EFA\u903B\u8F91\u8FD8\u662F\u66F4\u65B0\u903B\u8F91\u4E00\u5207\u7684\u6E90\u5934\u90FD\u662F\u4ECE<strong>processComponent</strong>\u5224\u65AD</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">const processComponent = (n1, n2, container, anchor) =&gt; {</span></span>
<span class="line"><span style="color:#A6ACCD;">    // \u7EDF\u4E00\u5904\u7406\u7EC4\u4EF6\uFF0C\u91CC\u9762\u518D\u533A\u5206\u662F\u666E\u901A\u7EC4\u4EF6\u8FD8\u662F\u51FD\u6570\u5F0F\u7EC4\u4EF6</span></span>
<span class="line"><span style="color:#A6ACCD;">    if (n1 == null) {</span></span>
<span class="line"><span style="color:#A6ACCD;">      // \u7EC4\u4EF6\u521B\u5EFA</span></span>
<span class="line"><span style="color:#A6ACCD;">      mountComponent(n2, container, anchor);</span></span>
<span class="line"><span style="color:#A6ACCD;">    } else {</span></span>
<span class="line"><span style="color:#A6ACCD;">      updateComponent(n1, n2);</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">};</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="\u4E8C\u3001\u7EC4\u4EF6\u7684\u66F4\u65B0updatecomponent" tabindex="-1">\u4E8C\u3001\u7EC4\u4EF6\u7684\u66F4\u65B0updateComponent <a class="header-anchor" href="#\u4E8C\u3001\u7EC4\u4EF6\u7684\u66F4\u65B0updatecomponent" aria-hidden="true">#</a></h2><p>\u5982\u679C\u6709\u65B0\u7684\u5B50\u8282\u70B9\u540C\u65F6\u65E7\u7684\u5B50\u8282\u70B9\u4E5F\u5B58\u5728\uFF0C\u90A3\u4E48\u5C31\u8D70<strong>updateComponent</strong>\u903B\u8F91\u3002</p><p>\u6CE8\u610F\uFF0C\u80FD\u89E6\u53D1<strong>updateComponent</strong>\u66F4\u65B0\u7684\u6A21\u5F0F\u7EC4\u4EF6\u7684\u7236\u7EC4\u4EF6\u7684render\u5BFC\u81F4\u7EC4\u4EF6\u53D1\u751F\u53D8\u5316\uFF0C\u624D\u4F1A\u8D70\u8FD9\u6BB5\u903B\u8F91\uFF0C\u53EF\u80FD\u662F\u901A\u8FC7props\u7684\u53D8\u5316\u53BB\u66F4\u65B0\u7EC4\u4EF6\u3002</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">const updateComponent = (n1, n2) =&gt; {</span></span>
<span class="line"><span style="color:#A6ACCD;">    // instance.props\u662F\u54CD\u5E94\u5F0F\u7684\uFF0C\u800C\u4E14\u53EF\u4EE5\u66F4\u6539 \u5C5E\u6027\u7684\u66F4\u65B0\u4F1A\u5BFC\u81F4\u9875\u9762\u91CD\u65B0\u6E32\u67D3</span></span>
<span class="line"><span style="color:#A6ACCD;">    // \u5BF9\u4E8E\u5143\u7D20\u800C\u8A00\uFF0C\u590D\u7528\u7684\u662Fdom\u8282\u70B9\uFF0C\u5BF9\u4E8E\u7EC4\u4EF6\u6765\u8BF4\u590D\u7528\u7684\u662F\u5B9E\u4F8B</span></span>
<span class="line"><span style="color:#A6ACCD;">    const instance = (n2.component = n1.component);</span></span>
<span class="line"><span style="color:#A6ACCD;">    // \u6211\u4EEC\u6539\u6210\u9700\u8981\u66F4\u65B0\u5C31\u5F3A\u5236\u8C03\u7528\u7EC4\u4EF6\u7684update\u65B9\u6CD5</span></span>
<span class="line"><span style="color:#A6ACCD;">    if (shouldUpdateComponent(n1, n2)) {</span></span>
<span class="line"><span style="color:#A6ACCD;">      // \u5C06\u65B0\u7684\u865A\u62DF\u8282\u70B9\u653E\u5230\u5B9E\u4F8B\u7684next\u5C5E\u6027\u4E0A\uFF0C\u56E0\u4E3A\u540E\u7EED\u8FD8\u8981\u7528\u5230</span></span>
<span class="line"><span style="color:#A6ACCD;">      instance.next = n2;</span></span>
<span class="line"><span style="color:#A6ACCD;">      instance.update(); // \u65E0\u8BBA\u662F\u7EC4\u4EF6\u8FD8\u662F\u63D2\u69FD\u9700\u8981\u66F4\u65B0\u7EDF\u4E00\u8C03\u7528update\u65B9\u6CD5\u6765\u66F4\u65B0\uFF0C\u8FD9\u4E2Aupdate\u5C31\u662F\u4E00\u5F00\u59CBsetupRenderEffect\u91CC\u9762\u7684effect.run/componentUpdateFn</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">};</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>\u5982\u4F55\u5224\u65AD\u4E00\u4E2A\u7EC4\u4EF6\u662F\u5426\u9700\u8981\u66F4\u65B0\u5462\uFF1F\u4E3B\u8981\u662F\u8C03\u7528<strong>shouldUpdateComponent</strong>\u8FD9\u4E2A\u5224\u65AD\u65B9\u6CD5</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">const shouldUpdateComponent = (n1, n2) =&gt; {</span></span>
<span class="line"><span style="color:#A6ACCD;">    const { props: prevProps, children: prevChildren } = n1;</span></span>
<span class="line"><span style="color:#A6ACCD;">    const { props: nextProps, children: nextChildren } = n2;</span></span>
<span class="line"><span style="color:#A6ACCD;">    if (prevProps === nextProps) return false;</span></span>
<span class="line"><span style="color:#A6ACCD;">    if (prevChildren || nextChildren) {</span></span>
<span class="line"><span style="color:#A6ACCD;">      // \u63D2\u69FD\u8981\u66F4\u65B0</span></span>
<span class="line"><span style="color:#A6ACCD;">      return true;</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">    return hasPropsChanged(prevProps, nextProps);</span></span>
<span class="line"><span style="color:#A6ACCD;">};</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>\u7B80\u800C\u8A00\u4E4B\u5C31\u662F\u6BD4\u8F83\u65B0\u65E7\u8282\u70B9\u7684props\uFF0C\u4EE5\u53CAslots\u7684\u5DEE\u5F02\u3002</p><p>props\u7684\u6BD4\u8F83\u65B9\u6CD5<strong>hasPropsChanged</strong>\u5C31\u66F4\u65B0j\u7B80\u5355\u4E86</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">const hasPropsChanged = (prevProps = {}, nextProps = {}) =&gt; {</span></span>
<span class="line"><span style="color:#A6ACCD;">  const nextKeys = Object.keys(nextProps);</span></span>
<span class="line"><span style="color:#A6ACCD;">  if (nextKeys.length !== Object.keys(prevProps).length) {</span></span>
<span class="line"><span style="color:#A6ACCD;">    // \u5BF9\u6BD4\u5C5E\u6027\u524D\u540E\u4E2A\u6570\u662F\u5426\u4E00\u81F4</span></span>
<span class="line"><span style="color:#A6ACCD;">    return true;</span></span>
<span class="line"><span style="color:#A6ACCD;">  }</span></span>
<span class="line"><span style="color:#A6ACCD;">  for (let i = 0; i &lt; nextKeys.length; i++) {</span></span>
<span class="line"><span style="color:#A6ACCD;">    // \u5BF9\u6BD4\u5C5E\u6027\u5BF9\u5E94\u7684\u503C\u662F\u5426\u4E00\u81F4</span></span>
<span class="line"><span style="color:#A6ACCD;">    const key = nextKeys[i];</span></span>
<span class="line"><span style="color:#A6ACCD;">    if (nextKeys[key] !== prevProps[key]) {</span></span>
<span class="line"><span style="color:#A6ACCD;">      return true;</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">  }</span></span>
<span class="line"><span style="color:#A6ACCD;">  return false;</span></span>
<span class="line"><span style="color:#A6ACCD;">};</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>\u5982\u679C\u6700\u540E\u5224\u65AD\u5B8C\u8FD8\u662F\u9700\u8981\u66F4\u65B0\uFF0C\u90A3\u4E48\u5C31\u5C06\u65B0\u5B50\u8282\u70B9\u8D4B\u503C\u7ED9\u5B9E\u4F8B\u7684<strong>next</strong>\u5C5E\u6027\uFF0C\u5E76\u4E14\u8C03\u7528\u5B9E\u4F8B\u4E0A\u7684<strong>update</strong>\u65B9\u6CD5\u3002</p><p>\u90A3\u4E48\u8FD9\u4E2A<strong>update</strong>\u662F\u54EA\u91CC\u6765\u7684\uFF1F\u8FD8\u8BB0\u5F97\u6211\u4EEC\u4E0A\u4E00\u8282\u7684<strong>componentUpdateFn</strong>\u65B9\u6CD5\u5417\uFF1F</p><p>\u6211\u4EEC\u5728<strong>setupRenderEffect</strong>\u91CC\u9762\u7684\u6700\u540E\u5C06reactiveEffect\u7684run\u65B9\u6CD5\u6302\u8F7D\u5230\u7EC4\u4EF6\u5B9E\u4F8B\u4E0A\uFF0Cupdate\u5C31\u662F\u4ECE\u90A3\u91CC\u62FF\u7684</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">instance.update = effect.run.bind(effect)</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>\u8FD8\u8BB0\u5F97\u4E0A\u4E00\u8282\u5728\u8BB2\u5230\u521B\u5EFA\u5B9E\u4F8B\u7684\u526F\u4F5C\u7528\u7684\u65F6\u5019\u6211\u4EEC\u63D0\u5230\u4E86\u8FD9\u6837\u4E00\u6BB5\u4EE3\u7801\u5417\uFF1F</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">const setupRenderEffect = (instance, container, anchor) =&gt; {</span></span>
<span class="line"><span style="color:#A6ACCD;">  const { render } = instance;</span></span>
<span class="line"><span style="color:#A6ACCD;">  // \u6536\u96C6\u7EC4\u4EF6\u91CC\u9762render\u65B9\u6CD5\u7684\u4F9D\u8D56</span></span>
<span class="line"><span style="color:#A6ACCD;">  const componentUpdateFn = () =&gt; {</span></span>
<span class="line"><span style="color:#A6ACCD;">  // \u533A\u5206\u662F\u521D\u59CB\u5316\u8FD8\u662F\u66F4\u65B0</span></span>
<span class="line"><span style="color:#A6ACCD;">  if (!instance.isMounted) {</span></span>
<span class="line"><span style="color:#A6ACCD;">    // \u521D\u59CB\u5316\uFF0Crender\u7684this\u6307\u5411\u4EE3\u7406\u5BF9\u8C61\uFF0C\u6267\u884Crender\u5C31\u80FD\u83B7\u53D6\u5230\u6700\u65B0\u7684vnode</span></span>
<span class="line"><span style="color:#A6ACCD;">    const subTree = render.call(instance.proxy);</span></span>
<span class="line"><span style="color:#A6ACCD;">    patch(null, subTree, container, anchor); //\u521B\u9020\u4E86subTree\u7684\u771F\u5B9E\u8282\u70B9\u5E76\u4E14\u63D2\u5165\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">    instance.subTree = subTree;</span></span>
<span class="line"><span style="color:#A6ACCD;">    instance.isMounted = true;</span></span>
<span class="line"><span style="color:#A6ACCD;">  } else {</span></span>
<span class="line"><span style="color:#A6ACCD;">    // \u7EC4\u4EF6\u5185\u90E8\u66F4\u65B0</span></span>
<span class="line"><span style="color:#A6ACCD;">    // \u5982\u679C\u662F\u7EC4\u4EF6\u91CC\u9762\u81EA\u5DF1\u5BFC\u81F4\u7684\u7EC4\u4EF6\u53D1\u751F\u53D8\u5316\uFF0C\u90A3\u4E48\u4F1A\u8D70\u8FD9\u6BB5\u903B\u8F91</span></span>
<span class="line"><span style="color:#A6ACCD;">    TODO: \u7EC4\u4EF6\u66F4\u65B0\u6D41\u7A0B</span></span>
<span class="line"><span style="color:#A6ACCD;">  }</span></span>
<span class="line"><span style="color:#A6ACCD;">};</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>\u901A\u8FC7<strong>instance.isMounted</strong>\u6765\u5224\u65AD\u7EC4\u4EF6\u662F\u5728\u521B\u5EFA\u7684\u6D41\u7A0B\u8FD8\u662F\u66F4\u65B0\u7684\u6D41\u7A0B\u3002\u90A3\u4E48\u8FD9\u4E2A\u66F4\u65B0\u7684\u6D41\u7A0B\u6307\u7684\u662F\u5565\uFF1F\u4E0A\u9762\u6211\u4EEC\u8BF4\u5230\uFF0C\u5982\u679C\u662F\u7236\u7EC4\u4EF6\u66F4\u65B0\u5BFC\u81F4\u5B50\u7EC4\u4EF6\u9700\u8981\u66F4\u65B0\u7684\u8BDD\uFF0C\u90A3\u4E48\u5C31\u662F\u6BD4\u8F83props\u548Cslots\uFF0C\u5982\u679C\u9700\u8981\u66F4\u65B0\u7684\u8BDD\u5C31\u4F1A\u8C03\u7528<strong>instance.update</strong>\u5F3A\u5236\u66F4\u65B0\u3002setupRenderEffect\u91CC\u9762\u7684\u66F4\u65B0\uFF0C\u6307\u7684\u662F\u7EC4\u4EF6\u5185\u90E8\u7684\u66F4\u65B0\uFF0C\u6BD4\u5982\u4E0B\u9762\u8FD9\u79CD\u60C5\u51B5</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">render(){</span></span>
<span class="line"><span style="color:#A6ACCD;">   setTimeout(()=&gt;{</span></span>
<span class="line"><span style="color:#A6ACCD;">     this.age++</span></span>
<span class="line"><span style="color:#A6ACCD;">   },1000)</span></span>
<span class="line"><span style="color:#A6ACCD;">   return h(&#39;p&#39;,\`{this.age}\`)</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>\u56E0\u4E3A\u7EC4\u4EF6\u5185\u90E8\u7684\u54CD\u5E94\u5F0F\u53D8\u91CF\u88ABeffect\u6536\u96C6\u4E86\uFF0C\u56E0\u6B64\u7EC4\u4EF6\u5185\u90E8\u7684\u66F4\u65B0\u4F1A\u81EA\u5DF1\u89E6\u53D1effect\u7684scheduler</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">let { next } = instance;</span></span>
<span class="line"><span style="color:#A6ACCD;">if (next) {</span></span>
<span class="line"><span style="color:#A6ACCD;">  // \u66F4\u65B0\u524D\u6211\u4E5F\u9700\u8981\u62FF\u5230\u6700\u65B0\u7684\u5C5E\u6027\u6765\u66F4\u65B0</span></span>
<span class="line"><span style="color:#A6ACCD;">  // \u4E0B\u9762\u8FD9\u4E2A\u65B9\u6CD5\u8868\u793A\u7EC4\u4EF6\u66F4\u65B0\u4E4B\u524D\u6211\u4EEC\u8981\u505A\u4EC0\u4E48\u4E8B</span></span>
<span class="line"><span style="color:#A6ACCD;">  updateComponentPreRender(instance, next);</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">/**</span></span>
<span class="line"><span style="color:#A6ACCD;"> * \u7EC4\u4EF6\u5185\u90E8\u7684\u66F4\u65B0\u6307\u7684\u662Frender(){}\u91CC\u9762\u7684\u66F4\u65B0\uFF0C\u5047\u8BBE\u91CC\u9762\u6709\u4E2A\u5B9A\u65F6\u5668</span></span>
<span class="line"><span style="color:#A6ACCD;"> * render(){</span></span>
<span class="line"><span style="color:#A6ACCD;"> *    setTimeout(()=&gt;{</span></span>
<span class="line"><span style="color:#A6ACCD;"> *      this.age++</span></span>
<span class="line"><span style="color:#A6ACCD;"> *    },1000)</span></span>
<span class="line"><span style="color:#A6ACCD;"> *    return h(&#39;p&#39;,\`{this.age}\`)</span></span>
<span class="line"><span style="color:#A6ACCD;"> * }</span></span>
<span class="line"><span style="color:#A6ACCD;"> * */</span></span>
<span class="line"><span style="color:#A6ACCD;">const subTree = render.call(instance.proxy);</span></span>
<span class="line"><span style="color:#A6ACCD;">patch(instance.subTree, subTree, container, anchor);</span></span>
<span class="line"><span style="color:#A6ACCD;">// \u5728patch\u6BD4\u8F83\u65B0\u65E7\u8282\u70B9\u4E4B\u540E\uFF0C\u8BB0\u5F97\u66F4\u65B0\u5B9E\u4F8B\u4E0A\u9762\u7684subTree\uFF0C\u65B9\u4FBF\u4E0B\u6B21\u4F7F\u7528</span></span>
<span class="line"><span style="color:#A6ACCD;">instance.subTree = subTree;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>\u6240\u4EE5\uFF0C\u73B0\u5728\u77E5\u9053\u4E3A\u4EC0\u4E48\u5728\u5B9E\u4F8B\u5316effect\u7684\u65F6\u5019\uFF0C\u9700\u8981\u901A\u8FC7scheduler\u8FD9\u79CD\u65B9\u5F0F\u53BB\u5B9E\u4F8B\u5316\u4E86\u5427\uFF1F</p><p>\u56E0\u4E3A\u5982\u679C\u662F\u8FD9\u4E48\u5904\u7406\u7684\u8BDD\uFF0C\u5916\u90E8\u7684\u66F4\u65B0\u53EF\u4EE5\u76F4\u63A5\u8C03\u7528effect\u5B9E\u4F8B\u66B4\u9732\u51FA\u6765\u7684run\u65B9\u6CD5\uFF0C\u5185\u90E8\u66F4\u65B0\u7684\u8BDD\u53EF\u4EE5\u76F4\u63A5\u89E6\u53D1scheduler\u8FD9\u4E2A\u56DE\u8C03\u3002</p><p>scheduler\u56DE\u8C03\u7684\u672C\u8D28\u8FD8\u662F\u8C03\u7528\u7ED1\u5728\u7EC4\u4EF6\u5B9E\u4F8B\u4E0A\u7684update\u65B9\u6CD5\u3002\u90A3\u4E48\u6309\u7167\u8FD9\u4E48\u8BF4\u7684\u8BDD\uFF0C\u672C\u6765\u6211\u4EEC\u76F4\u63A5\u8FD9\u4E48\u5199\u5C31\u53EF\u4EE5\u4E86</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">const effect = new ReactiveEffect(componentUpdateFn,instance.update);</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>\u4E3A\u4EC0\u4E48\u8981\u5728<strong>instance.update</strong>\u7684\u5916\u5C42\u5305\u4E00\u5C42<strong>queueJob</strong>\u5462\uFF1F</p><p>queueJob\u5176\u5B9E\u5C31\u662F\u4E00\u4E2A\u6279\u91CF\u5904\u7406\u7684\u65B9\u6CD5\uFF0C\u5047\u8BBE\u73B0\u5728\u6709\u8FD9\u4E48\u4E00\u79CD\u5185\u90E8\u66F4\u65B0\u7684\u60C5\u51B5</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">render(){</span></span>
<span class="line"><span style="color:#A6ACCD;">   setTimeout(()=&gt;{</span></span>
<span class="line"><span style="color:#A6ACCD;">     this.age++;</span></span>
<span class="line"><span style="color:#A6ACCD;">     this.age++</span></span>
<span class="line"><span style="color:#A6ACCD;">   },1000)</span></span>
<span class="line"><span style="color:#A6ACCD;">   return h(&#39;p&#39;,\`{this.age}\`)</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>\u5982\u679C\u4E0D\u5904\u7406\u7684\u8BDD\u6539\u53D8\u51E0\u6B21\u54CD\u5E94\u5F0F\u6570\u636E\u5C31\u4F1A\u89E6\u53D1\u51E0\u6B21scheduler\uFF0C\u5BFC\u81F4\u6027\u80FD\u53D8\u5DEE\u3002</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">const queue = [];</span></span>
<span class="line"><span style="color:#A6ACCD;">// \u662F\u5426\u6B63\u5728\u5237\u65B0</span></span>
<span class="line"><span style="color:#A6ACCD;">let isFlushing = false;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">const resolvePromise = Promise.resolve();</span></span>
<span class="line"><span style="color:#A6ACCD;">export function queueJob(job) {</span></span>
<span class="line"><span style="color:#A6ACCD;">  // \u5982\u679C\u5B9A\u65F6\u5668\u5185\u8FDE\u7EED\u591A\u6B21\u66F4\u65B0\uFF0C\u90A3\u4E48\u5C31\u4F1A\u89E6\u53D1\u591A\u6B21scheduler</span></span>
<span class="line"><span style="color:#A6ACCD;">  if (!queue.includes(job)) {</span></span>
<span class="line"><span style="color:#A6ACCD;">    queue.push(job);</span></span>
<span class="line"><span style="color:#A6ACCD;">  }</span></span>
<span class="line"><span style="color:#A6ACCD;">  // \u591A\u6B21\u66F4\u65B0\uFF0C\u7B2C\u4E00\u6B21\u66F4\u65B0\u4F1A\u8D70\u4E0B\u9762\u7684if\uFF0C\u4E0B\u6B21\u66F4\u65B0\u5C31\u4E0D\u4F1A\u8D70\u4E0B\u9762\u7684if,job\u91CC\u9762\u5C31\u662F\u4E2Arender</span></span>
<span class="line"><span style="color:#A6ACCD;">  if (!isFlushing) {</span></span>
<span class="line"><span style="color:#A6ACCD;">    // \u6279\u5904\u7406\u903B\u8F91</span></span>
<span class="line"><span style="color:#A6ACCD;">    isFlushing = true;</span></span>
<span class="line"><span style="color:#A6ACCD;">    resolvePromise.then(() =&gt; {</span></span>
<span class="line"><span style="color:#A6ACCD;">      // \u8FD9\u91CC\u662F\u4E00\u4E2A\u5FAE\u4EFB\u52A1</span></span>
<span class="line"><span style="color:#A6ACCD;">      isFlushing = false;</span></span>
<span class="line"><span style="color:#A6ACCD;">      let copy = queue.slice(0);</span></span>
<span class="line"><span style="color:#A6ACCD;">      queue.length = 0;</span></span>
<span class="line"><span style="color:#A6ACCD;">      for (let i = 0; i &lt; copy.length; i++) {</span></span>
<span class="line"><span style="color:#A6ACCD;">        let job = copy[i];</span></span>
<span class="line"><span style="color:#A6ACCD;">        job();</span></span>
<span class="line"><span style="color:#A6ACCD;">      }</span></span>
<span class="line"><span style="color:#A6ACCD;">      // \u8FD9\u4E00\u6B65\u64CD\u4F5C\u4E0D\u80FD\u653E\u5728\u8FD9\u91CC\uFF0C\u56E0\u4E3A\u6267\u884Cjob\u7684\u65F6\u5019\uFF0C\u53C8\u653E\u4E86\u4E00\u4E9B\u4EFB\u52A1\uFF0C\u90A3\u8FD9\u4E2A\u4EFB\u52A1\u8FDB\u5165\u5230\u4E86queue\u91CC\u9762\uFF0C\u4F46\u662F\u5728job\u6267\u884C\u5B8C\u4E4B\u540E\u5C31\u6E05\u7A7A\u4E86\uFF0C\u7136\u540E\u5C31\u4E22\u5931\u4E86</span></span>
<span class="line"><span style="color:#A6ACCD;">      // queue.length = 0;</span></span>
<span class="line"><span style="color:#A6ACCD;">      copy.length = 0;</span></span>
<span class="line"><span style="color:#A6ACCD;">    });</span></span>
<span class="line"><span style="color:#A6ACCD;">  }</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>\u4E0A\u8FF0\u5C31\u662F\u7EC4\u4EF6\u7684\u66F4\u65B0\u6D41\u7A0B\u3002</p><p>\u6700\u540E\u6211\u4EEC\u5728\u4F7F\u7528\u7EC4\u4EF6\u7684\u65F6\u5019\u5E94\u8BE5\u662F\u8FD9\u4E48\u7528\u7684</p><div class="language- line-numbers-mode"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">const VueComponent = {</span></span>
<span class="line"><span style="color:#A6ACCD;">  props: {</span></span>
<span class="line"><span style="color:#A6ACCD;">    address: String,</span></span>
<span class="line"><span style="color:#A6ACCD;">  },</span></span>
<span class="line"><span style="color:#A6ACCD;">  setup(props) {</span></span>
<span class="line"><span style="color:#A6ACCD;">    const name = ref(&#39;nangxif&#39;);</span></span>
<span class="line"><span style="color:#A6ACCD;">    const age = ref(&#39;27&#39;);</span></span>
<span class="line"><span style="color:#A6ACCD;">    setTimeout(() =&gt; {</span></span>
<span class="line"><span style="color:#A6ACCD;">      age.value++;</span></span>
<span class="line"><span style="color:#A6ACCD;">    }, 1000);</span></span>
<span class="line"><span style="color:#A6ACCD;">    return { name, age, address: props.address + &#39;\u5E7F\u5DDE&#39; };</span></span>
<span class="line"><span style="color:#A6ACCD;">  },</span></span>
<span class="line"><span style="color:#A6ACCD;">  render() {</span></span>
<span class="line"><span style="color:#A6ACCD;">    return h(Fragment, [this.name, this.age, this.address]);</span></span>
<span class="line"><span style="color:#A6ACCD;">  },</span></span>
<span class="line"><span style="color:#A6ACCD;">};</span></span>
<span class="line"><span style="color:#A6ACCD;">render(h(VueComponent, { address: &#39;\u5730\u7403&#39; }), app);</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div>`,35),r=[l];function c(o,t,i,b,C,u){return a(),n("div",null,r)}const d=s(e,[["render",c]]);export{m as __pageData,d as default};
